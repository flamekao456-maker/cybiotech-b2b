const express = require('express');
const axios = require('axios');
const jwt = require('jsonwebtoken');
const User = require('../models/User');
const router = express.Router();

// LINE 登入跳轉
router.get('/line-login', (req, res) => {
  const userId = req.query.userId;
  const state = Buffer.from(userId).toString('base64');
  const redirectUri = encodeURIComponent(`${process.env.BASE_URL || 'http://localhost:3000'}/auth/callback`);
  const authUrl = `https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=${process.env.LINE_LOGIN_CHANNEL_ID}&redirect_uri=${redirectUri}&state=${state}&scope=profile%20openid&prompt=consent`;

  const consentPage = `${process.env.BASE_URL || 'http://localhost:3000'}/consent.html?redirect=${encodeURIComponent(authUrl)}`;
  res.redirect(consentPage);
});

// Callback 處理
router.get('/callback', async (req, res) => {
  const code = req.query.code;
  const state = req.query.state;
  const originalUserId = Buffer.from(state, 'base64').toString();

  try {
    const tokenRes = await axios.post('https://api.line.me/oauth2/v2.1/token', new URLSearchParams({
      grant_type: 'authorization_code',
      code,
      redirect_uri: `${process.env.BASE_URL || 'http://localhost:3000'}/auth/callback`,
      client_id: process.env.LINE_LOGIN_CHANNEL_ID,
      client_secret: process.env.LINE_LOGIN_CHANNEL_SECRET
    }), { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } });

    const { access_token } = tokenRes.data;
    const profileRes = await axios.get('https://api.line.me/v2/profile', { headers: { Authorization: `Bearer ${access_token}` } });
    const profile = profileRes.data;

    // 從 localStorage 拿資料（簡化版，實際可透過 POST 傳）
    const b2bData = JSON.parse(localStorage.getItem('cybiotech_b2b_data') || '{}'); // 這是簡化，實際用 query

    let user = await User.findOneAndUpdate(
      { lineUserId: profile.userId },
      {
        displayName: profile.displayName,
        pictureUrl: profile.pictureUrl || '',
        orgName: b2bData.org || '',
        ownerName: b2bData.owner || '',
        phone: b2bData.phone || '',
        salesName: b2bData.sales || '',
        consentPolicy: true,
        consentPrivacy: true,
        consentAgreedAt: new Date()
      },
      { upsert: true, new: true }
    );

    const token = jwt.sign({ id: user._id, lineUserId: user.lineUserId }, process.env.JWT_SECRET, { expiresIn: '30d' });

    res.send(`
      <h2>登入成功！</h2>
      <p>歡迎 ${profile.displayName} (${b2bData.org || '客戶'})</p>
      <script>setTimeout(() => window.close(), 3000);</script>
    `);
  } catch (err) {
    res.status(500).send('登入失敗');
  }
});

module.exports = router;